import streamlit as st
import re
import json
from google import genai
from google.genai.errors import APIError as GeminiAPIError
from typing import List, Dict, Any, Optional

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø GEMINI –ò API –ö–õ–Æ–ß–ò ---
# –ö–ª—é—á –±–µ—Ä–µ—Ç—Å—è –∏–∑ .streamlit/secrets.toml
try:
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–∞
    GEMINI_API_KEY = st.secrets["GEMINI_API_KEY"]
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini Client
    client = genai.Client(api_key=GEMINI_API_KEY)
    
    API_KEYS_LOADED = True
except KeyError:
    st.error("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å `GEMINI_API_KEY` –∏–∑ .streamlit/secrets.toml.")
    API_KEYS_LOADED = False
except Exception as e:
    st.error(f"‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ Gemini: {e}")
    API_KEYS_LOADED = False

# --- –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Gemini) ---
# –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É: –¢–µ–∑–∏—Å, –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç
SYSTEM_PROMPT = """
–¢—ã —è–≤–ª—è–µ—à—å—Å—è —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø–æ –ª–∏–Ω–≥–≤–∏—Å—Ç–∏—á–µ—Å–∫–æ–º—É –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ç–∏–≤–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É —Ç–µ–∫—Å—Ç–∞.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1.  **–ü—Ä–∏–Ω—è—Ç—å** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
2.  **–†–∞–∑–¥–µ–ª–∏—Ç—å** —Ç–µ–∫—Å—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
3.  **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å** –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å–æ–≥–ª–∞—Å–Ω–æ –µ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ç–∏–≤–Ω–æ–π —Ä–æ–ª–∏.
4.  **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏** –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:
    * **"–¢–µ–∑–∏—Å"**: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ—Å–µ—Ç –æ—Ü–µ–Ω–æ—á–Ω–æ–µ –∏–ª–∏ –æ–±–æ–±—â–∞—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–∑–∏—Ü–∏—é.
    * **"–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ"**: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –ø—Ä–∏–º–µ—Ä, —Ñ–∞–∫—Ç—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–ª–∏ –¥–µ—Ç–∞–ª–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ —Ç–µ–∑–∏—Å.
    * **"–ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç"**: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ, –æ—Å–ø–∞—Ä–∏–≤–∞–µ—Ç —Ç–µ–∑–∏—Å –∏–ª–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è.
    * **"–î—Ä—É–≥–æ–µ"**: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —è–≤–Ω–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ç–∏–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–≤–æ–¥–Ω–æ–µ, —Å–≤—è–∑—É—é—â–µ–µ –∏–ª–∏ —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ).
5.  **–í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON**, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ö–µ–º—É.
"""

# --- –°–•–ï–ú–ê JSON –î–õ–Ø GEMINI ---
# –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –∏—Ö —Ç–∏–ø–æ–≤
RESPONSE_SCHEMA = {
    "type": "OBJECT",
    "properties": {
        "analysis_results": {
            "type": "ARRAY",
            "description": "–°–ø–∏—Å–æ–∫ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏–∑ —Ç–µ–∫—Å—Ç–∞.",
            "items": {
                "type": "OBJECT",
                "properties": {
                    "sentence": {
                        "type": "STRING", 
                        "description": "–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞."
                    },
                    "type": {
                        "type": "STRING",
                        "description": "–¢–∏–ø –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–¢–µ–∑–∏—Å, –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç, –î—Ä—É–≥–æ–µ).",
                        "enum": ["–¢–µ–∑–∏—Å", "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ", "–ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç", "–î—Ä—É–≥–æ–µ"]
                    },
                    "explanation": {
                        "type": "STRING",
                        "description": "–ö—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–Ω–µ—Å–µ–Ω–æ –∫ —ç—Ç–æ–º—É —Ç–∏–ø—É."
                    }
                },
                "required": ["sentence", "type", "explanation"]
            }
        }
    },
    "required": ["analysis_results"]
}

# ===============================================================
# –§–£–ù–ö–¶–ò–Ø (Gemini API)
# ===============================================================

@st.cache_data(show_spinner=False)
def analyze_arguments_with_gemini(text_to_analyze: str) -> Optional[Dict[str, Any]]:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∞–ª–∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (—Ç–µ–∑–∏—Å/–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ/...) —á–µ—Ä–µ–∑ Gemini API.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π JSON-–≤—ã–≤–æ–¥.
    """
    if not API_KEYS_LOADED:
        return None
    
    try:
        # 1. –ó–∞–ø—Ä–æ—Å –∫ Gemini
        response = client.models.generate_content(
            #
            # ‚ùóÔ∏è –û—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à—É –º–æ–¥–µ–ª—å gemini-2.5-flash-preview-09-2025
            # –ï—Å–ª–∏ –æ–Ω–∞ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ 'gemini-1.5-flash-latest'
            #
            model='gemini-2.5-flash-preview-09-2025', 
            contents=[{"role": "user", "parts": [{"text": f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç: {text_to_analyze}"}]}],
            config={
                "system_instruction": SYSTEM_PROMPT,
                "response_mime_type": "application/json",
                "response_schema": RESPONSE_SCHEMA
            }
        )
        
        # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        return json.loads(response.text)
    
    except GeminiAPIError as e:
        error_msg = str(e)
        st.error(f"–û—à–∏–±–∫–∞ Gemini API: {error_msg}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–≤–æ—Ç—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏.")
        return None
    except Exception as e:
        error_msg = str(e)
        st.error(f"–û—à–∏–±–∫–∞ Gemini Client: {error_msg}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–ª—é—á –≤–µ—Ä–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –±–∏–ª–ª–∏–Ω–≥.")
        return None

# ===============================================================
# –ò–ù–¢–ï–†–§–ï–ô–° STREAMLIT
# ===============================================================

st.set_page_config(page_title="–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ê—Ä–≥—É–º–µ–Ω—Ç–æ–≤", layout="wide")
st.title("üìú –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–¢–µ–∑–∏—Å / –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ)")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π
if API_KEYS_LOADED:
    
    # 1. –ü–æ–ª–µ –≤–≤–æ–¥–∞
    st.header("1. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:")
    
    # –ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–¥–∞—á–µ
    example_text = """–ò–∑—É—á–µ–Ω–∏–µ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è. 
–í–æ-–ø–µ—Ä–≤—ã—Ö, —ç—Ç–æ —É–ª—É—á—à–∞–µ—Ç –ø–∞–º—è—Ç—å –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –≤–Ω–∏–º–∞–Ω–∏—è. 
–í–æ-–≤—Ç–æ—Ä—ã—Ö, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ –±–∏–ª–∏–Ω–≥–≤—ã –ª—É—á—à–µ —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å—é. 
–û–¥–Ω–∞–∫–æ, –º–Ω–æ–≥–∏–µ —Å—á–∏—Ç–∞—é—Ç —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–º –∏ –∑–∞—Ç—Ä–∞—Ç–Ω—ã–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –±–∞—Ä—å–µ—Ä–æ–º –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö."""
    
    text_input = st.text_area("–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ –∏–ª–∏ –∫–æ—Ä–ø—É—Å–∞:", value=example_text, height=200)

    # 2. –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
    if st.button("‚ñ∂Ô∏è –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç"):
        if not text_input.strip():
            st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
            st.stop()
            
        # 3. –ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é Gemini
        with st.spinner("‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç (Gemini API)..."):
            gemini_result = analyze_arguments_with_gemini(text_input)

        st.header("2. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:")

        if gemini_result:
            analysis_data = gemini_result.get('analysis_results', [])
            
            if not analysis_data:
                st.warning("–ê–Ω–∞–ª–∏–∑ –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç.")
            else:
                # 4. –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                for item in analysis_data:
                    sentence = item.get('sentence', 'N/A')
                    arg_type = item.get('type', '–î—Ä—É–≥–æ–µ')
                    explanation = item.get('explanation', '–ù–µ—Ç –ø–æ—è—Å–Ω–µ–Ω–∏—è.')

                    if arg_type == "–¢–µ–∑–∏—Å":
                        st.markdown(f"### üìå –¢–µ–∑–∏—Å")
                        st.markdown(f"> **{sentence}**")
                    elif arg_type == "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ":
                        st.markdown(f"### ‚û°Ô∏è –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ")
                        st.markdown(f"> {sentence}")
                    elif arg_type == "–ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç":
                        st.markdown(f"### üîÑ –ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç")
                        st.markdown(f"> {sentence}")
                    else:
                        st.markdown(f"### üìÑ –î—Ä—É–≥–æ–µ")
                        st.markdown(f"> {sentence}")
                    
                    st.caption(f"–ü–æ—è—Å–Ω–µ–Ω–∏–µ: {explanation}")
                    st.divider()
        else:
            st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Gemini.")